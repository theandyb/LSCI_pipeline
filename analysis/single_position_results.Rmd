---
title: "single_position_results"
author: "Andy Beck"
date: "2025-01-06"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Notes

* Save figures using something along the lines of `ggsave("file.png", dpi=300)`

## Setup

### Libraries

```{r}
library(tidyverse)
library(ggpubfigs) # functions for color blind friendly palettes
library(reactable) # table output for html
library(knitr) # PDF table output
```

### Paths

```{r}
base_dir = "output"
single_pos_dir = paste0(base_dir, "/single_pos")

figure_output = paste0(base_dir, "/figs/single_pos")
```


### Base Functions

Load position-level results:

```{r}
get_pos_results <- function(res_dir, pop, subtype){
  f_name <- paste0(res_dir, "/", pop, "/", subtype, ".csv")
  df <- read_csv(f_name, show_col_types = FALSE) %>%
    rowwise() %>%
    mutate(re = dev / (2 * (singletons+controls)))
  return(df)
}
```

Load position-level residuals:

```{r}
get_pos_resid <- function(res_dir, pop, subtype, rp){
  f_name <- paste0(res_dir, "/resid/", pop, "/", subtype, "_rp_", rp, ".csv")
  df <- read_csv(f_name, show_col_types = FALSE)
  df$rp <- rp
  return(df)
}

get_pos_resid_all <- function(res_dir, pop, subtype, rp = c(-500:-1, 1:500)){
  results <- vector(mode = "list", length = length(rp))
  for(i in 1:length(rp)){
    results[[i]] <- get_pos_resid(res_dir, pop, subtype, rp[i])
  }
  df <- bind_rows(results)
  return(df)
}
```

### Figure Functions

```{r}
pos_level_line <- function(res_df, rp_lim = 20){
  p <- res_df %>%
    filter(abs(offset) <= rp_lim) %>%
    ggplot(aes(x = offset, y = re)) +
    geom_point() +
    geom_line() +
    theme_classic() +
    theme(text = element_text(family = "Arial"),
          legend.position = "inside",
          legend.position.inside = c(.85, .8)) +
    xlab("Relative Position") +
    ylab("Relative Entropy")
  return(p)
}

pos_level_dot <- function(res_df, palette_name = "contrast_three"){
  p <- res_df %>%
    mutate(sig = dev < qchisq(0.95, 3)) %>%
    ggplot(aes(x = offset, y = re, color = sig)) +
    scale_y_log10() +
    geom_point() +
    scale_color_manual(values = friendly_pal(palette_name)) +
    theme_classic() +
    theme(text = element_text(family = "Arial"),
          legend.position = "inside",
          legend.position.inside = c(.85, .8)) +
    xlab("Relative Position") +
    ylab("Log10 Relative Entropy") +
    labs(color = "Significant")
  return(p)
}
```


## Position Level Result Plots

### A > G

```{r}
subtype <- "AT_GC"
```


#### ALL

```{r}
pop <- "ALL"
df_results <- get_pos_results(single_pos_dir, pop = pop, subtype = subtype)

pos_level_line(df_results) 
pos_level_dot(df_results)
pos_level_line(df_results) + scale_y_log10() + ylab("Relative Entropy (log10)")
```

For the A > G mutation subtype, we observe the strongest signal of influence (relative entropy) at the +1 relative position. We observed that, in general, the signal decreases as positions further from the focal (0) position are considered, but note that this pattern is not monotonic in either direction, with the most obvious example of this being the stronger signal observed at -2 relative to the signal observed at -1. When compared to the critical value for a $\chi^2$ distribution with 3 degrees of freedom at the $\alpha=0.05$ level of significance, we find that the underlying deviance statistics remain significant up to approximately +/- 250bp; from here, we see values hover in a range that includes values which are not significant. The above results are based on the distributions of nucleotides flanking singletons and their matched controls across all five 1kGP super-populations; we next plot the results for each super-population individually:

#### AFR

```{r}
pop <- "AFR"
df_results <- get_pos_results(single_pos_dir, pop = pop, subtype = subtype)

pos_level_line(df_results) 
pos_level_dot(df_results)
pos_level_line(df_results) + scale_y_log10() + ylab("Relative Entropy (log10)")
```

#### AMR

```{r}
pop <- "AMR"
df_results <- get_pos_results(single_pos_dir, pop = pop, subtype = subtype)

pos_level_line(df_results) 
pos_level_dot(df_results)
pos_level_line(df_results) + scale_y_log10() + ylab("Relative Entropy (log10)")
```

#### EAS

```{r}
pop <- "EAS"
df_results <- get_pos_results(single_pos_dir, pop = pop, subtype = subtype)

pos_level_line(df_results) 
pos_level_dot(df_results)
pos_level_line(df_results) + scale_y_log10() + ylab("Relative Entropy (log10)")
```

#### EUR

```{r}
pop <- "EUR"
df_results <- get_pos_results(single_pos_dir, pop = pop, subtype = subtype)

pos_level_line(df_results) 
pos_level_dot(df_results)
pos_level_line(df_results) + scale_y_log10() + ylab("Relative Entropy (log10)")
```

#### SAS

```{r}
pop <- "EUR"
df_results <- get_pos_results(single_pos_dir, pop = pop, subtype = subtype)

pos_level_line(df_results) 
pos_level_dot(df_results)
pos_level_line(df_results) + scale_y_log10() + ylab("Relative Entropy (log10)")
```

### A > C

```{r}
subtype <- "AT_CG"
```

#### ALL

```{r}
pop <- "ALL"
df_results <- get_pos_results(single_pos_dir, pop = pop, subtype = subtype)

pos_level_line(df_results) 
pos_level_dot(df_results)
pos_level_line(df_results) + scale_y_log10() + ylab("Relative Entropy (log10)")
```

#### AFR

```{r}
pop <- "AFR"
df_results <- get_pos_results(single_pos_dir, pop = pop, subtype = subtype)

pos_level_line(df_results) 
pos_level_dot(df_results)
pos_level_line(df_results) + scale_y_log10() + ylab("Relative Entropy (log10)")
```

#### AMR

```{r}
pop <- "AMR"
df_results <- get_pos_results(single_pos_dir, pop = pop, subtype = subtype)

pos_level_line(df_results) 
pos_level_dot(df_results)
pos_level_line(df_results) + scale_y_log10() + ylab("Relative Entropy (log10)")
```

#### EAS

```{r}
pop <- "EAS"
df_results <- get_pos_results(single_pos_dir, pop = pop, subtype = subtype)

pos_level_line(df_results) 
pos_level_dot(df_results)
pos_level_line(df_results) + scale_y_log10() + ylab("Relative Entropy (log10)")
```

#### EUR

```{r}
pop <- "EUR"
df_results <- get_pos_results(single_pos_dir, pop = pop, subtype = subtype)

pos_level_line(df_results) 
pos_level_dot(df_results)
pos_level_line(df_results) + scale_y_log10() + ylab("Relative Entropy (log10)")
```

#### SAS

```{r}
pop <- "EUR"
df_results <- get_pos_results(single_pos_dir, pop = pop, subtype = subtype)

pos_level_line(df_results) 
pos_level_dot(df_results)
pos_level_line(df_results) + scale_y_log10() + ylab("Relative Entropy (log10)")
```
